# Claude Orchestrator - Environment Configuration
# Copy this file to .env and update with your actual values

# ==============================================================================
# CRITICAL SECURITY CONFIGURATION
# ==============================================================================

# Workspace base directory (REQUIRED - NO DEFAULT for security)
# Must be explicitly set to a dedicated directory with restrictive permissions
# Recommended: chmod 700 /path/to/workspaces
#
# SECURITY NOTES:
# - DO NOT use /tmp (world-writable, deleted on reboot)
# - Use a dedicated directory outside web root
# - Ensure directory has mode 0700 or 0750
# - Owner should be the application user only
#
# Examples:
#   WORKSPACE_BASE=/opt/claude-workspaces
#   WORKSPACE_BASE=/home/orchestrator/workspaces
#   WORKSPACE_BASE=/var/lib/claude/workspaces
WORKSPACE_BASE=

# ==============================================================================
# DATABASE CONFIGURATION
# ==============================================================================

# PostgreSQL connection string
# Format: postgresql://user:password@host:port/database
DATABASE_URL=postgresql://user:password@localhost:5432/claude_orchestrator

# ==============================================================================
# API SERVER CONFIGURATION
# ==============================================================================

# Port for the API server
API_PORT=3001

# ==============================================================================
# SECURITY & LOGGING
# ==============================================================================

# Directory for security logs and application logs
# Recommended: dedicated log directory with restricted permissions (chmod 750)
LOG_DIR=/var/log/claude-orchestrator

# Rate Limiting Configuration
# Window duration in milliseconds (default: 15 minutes)
RATE_LIMIT_WINDOW_MS=900000

# Maximum requests per IP within the window (default: 10)
RATE_LIMIT_MAX_REQUESTS=10

# ==============================================================================
# RESOURCE LIMITS
# ==============================================================================

# Maximum repository size in bytes (default: 1GB)
# Prevents resource exhaustion from cloning large repositories
MAX_REPO_SIZE_BYTES=1073741824

# Git clone timeout in milliseconds (default: 5 minutes)
# Prevents timeout attacks via slow clones
GIT_CLONE_TIMEOUT_MS=300000

# Git worktree creation timeout in milliseconds (default: 1 minute)
GIT_WORKTREE_TIMEOUT_MS=60000

# ==============================================================================
# EVENT DELIVERY & RETRY CONFIGURATION
# ==============================================================================

# Directory for event logs (used by hook scripts and retry daemon)
# Must be writable by both Claude Code hooks and the API server
# Recommended: dedicated directory with permissions 0750
EVENT_LOG_DIR=/var/log/claude-orchestrator/events

# Enable or disable the retry daemon (default: true)
# Set to "false" to disable automatic retry of failed events
ENABLE_RETRY_DAEMON=true

# Interval between retry checks in milliseconds (default: 30000 = 30 seconds)
RETRY_INTERVAL_MS=30000

# Maximum retry attempts before moving to dead letter queue (default: 10)
MAX_RETRY_ATTEMPTS=10

# HTTP timeout for retry requests in milliseconds (default: 5000 = 5 seconds)
RETRY_TIMEOUT_MS=5000

# Hook timeout in seconds (used by hook scripts)
# Time to wait for API response before considering delivery failed
HOOK_TIMEOUT=5

# ==============================================================================
# WORKSPACE CLEANUP CONFIGURATION
# ==============================================================================

# Enable automatic cleanup when session status changes to 'completed' or 'error'
# Default: true
ENABLE_AUTO_CLEANUP=true

# Enable scheduled cleanup job (uses node-cron)
# Default: true
ENABLE_SCHEDULED_CLEANUP=true

# Cron expression for cleanup job schedule
# Default: "0 * * * *" (every hour at minute 0)
# Examples:
#   "0 * * * *"     - Every hour
#   "0 */6 * * *"   - Every 6 hours
#   "0 0 * * *"     - Daily at midnight
#   "0 0 * * 0"     - Weekly on Sunday at midnight
CLEANUP_CRON_EXPRESSION=0 * * * *

# Hours to wait before cleaning up completed/error sessions
# Sessions older than this will be cleaned up by the scheduled job
# Default: 24 (hours)
CLEANUP_INTERVAL_HOURS=24

# Delete session records from database after cleanup
# If false, sessions are marked with cleaned_at timestamp but preserved
# Default: false (preserve session records for auditing)
CLEANUP_DELETE_SESSIONS=false

# ==============================================================================
# WORKSPACE QUOTA CONFIGURATION
# ==============================================================================

# Maximum number of concurrent workspaces allowed
# New workspace creation will fail if this limit is reached
# Default: 100
MAX_WORKSPACES=100

# Minimum free disk space required (in GB) to create new workspaces
# New workspace creation will fail if available space is below this threshold
# Default: 5 (GB)
MIN_DISK_SPACE_GB=5

# ==============================================================================
# WORKSPACE ARCHIVAL CONFIGURATION
# ==============================================================================
#
# SYSTEM REQUIREMENT: When ARCHIVE_WORKSPACES=true, the `tar` command must be
# available in PATH. If tar is not found at startup, archival will be
# automatically disabled with a warning.
#
# Install tar:
#   - Debian/Ubuntu: apt-get install tar
#   - Alpine: apk add tar
#   - macOS: pre-installed
#   - Windows: install via Git Bash or WSL

# Enable archival of workspaces before deletion
# Creates tar.gz archives for audit/recovery purposes
# Default: false
ARCHIVE_WORKSPACES=false

# Directory to store workspace archives
# Only used when ARCHIVE_WORKSPACES=true
# Default: /var/archives/claude-workspaces
ARCHIVE_DIR=/var/archives/claude-workspaces

# ==============================================================================
# BLOB STORAGE CONFIGURATION
# ==============================================================================
#
# Tool results larger than 100KB are stored in blob storage instead of inline
# in the database. This enables full result capture while keeping the database
# performant. The API provides a streaming endpoint for retrieving blob content.
#
# Storage Types:
# - local: Store blobs on local filesystem (recommended for development)
# - s3: Store blobs in AWS S3 or S3-compatible storage (recommended for production)

# Storage type: 'local' or 's3' (default: local)
BLOB_STORAGE=local

# ==============================================================================
# LOCAL BLOB STORAGE (when BLOB_STORAGE=local)
# ==============================================================================

# Path for local blob storage (default: /var/orchestrator/blobs)
# Must be writable by the API server process
# Recommended: dedicated directory with permissions 0750
BLOB_LOCAL_PATH=/var/orchestrator/blobs

# ==============================================================================
# S3 BLOB STORAGE (when BLOB_STORAGE=s3)
# ==============================================================================

# S3 bucket name (REQUIRED when BLOB_STORAGE=s3)
# Ensure bucket exists and has appropriate IAM permissions
# S3_BUCKET=claude-orchestrator-blobs

# AWS region for S3 (default: us-east-1)
# S3_REGION=us-east-1

# Custom S3 endpoint for MinIO or other S3-compatible storage
# Leave unset for AWS S3
# Examples:
#   S3_ENDPOINT=http://localhost:9000          # Local MinIO
#   S3_ENDPOINT=https://minio.example.com      # Self-hosted MinIO
#   S3_ENDPOINT=https://s3.us-west-2.amazonaws.com  # Specific AWS endpoint
# S3_ENDPOINT=

# AWS credentials (standard AWS SDK environment variables)
# For production, prefer IAM roles or instance profiles over static credentials
# AWS_ACCESS_KEY_ID=your-access-key
# AWS_SECRET_ACCESS_KEY=your-secret-key

# ==============================================================================
# SECRET SCRUBBING CONFIGURATION
# ==============================================================================

# Enable secret scrubbing for tool results and inputs
# When enabled, API keys, tokens, passwords, and other sensitive data
# are automatically redacted before being stored in the database.
# Default: true (recommended for all environments)
SCRUB_SECRETS=true

# Audit log file for scrubbed secrets (for compliance/monitoring)
# Logs detected secret types without exposing actual values.
# This is in addition to the standard security.log file.
# Default: Uses LOG_DIR/secrets-scrubbed.log
# SECRET_AUDIT_LOG=/var/log/claude-orchestrator/secrets-scrubbed.log

# ==============================================================================
# ENCRYPTION AT REST (OPTIONAL - HIGH SECURITY ENVIRONMENTS)
# ==============================================================================

# Enable encryption at rest for tool results
# When enabled, sensitive data is encrypted using AES-256-GCM before storage.
# This provides an additional layer of protection beyond scrubbing.
# Requires ENCRYPTION_KEY to be set.
# Default: false
ENABLE_ENCRYPTION_AT_REST=false

# Encryption key for AES-256-GCM (64-character hex string = 32 bytes)
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
# CRITICAL: Store this key securely - losing it means losing encrypted data!
# Only required if ENABLE_ENCRYPTION_AT_REST=true
# ENCRYPTION_KEY=

# ==============================================================================
# OPTIONAL: N8N INTEGRATION
# ==============================================================================

# Base URL for n8n webhook callbacks (if using n8n workflows)
# N8N_WEBHOOK_BASE=http://localhost:5678

# ==============================================================================
# OPTIONAL: SLACK INTEGRATION
# ==============================================================================

# Slack Bot Token (starts with xoxb-)
# Get from: https://api.slack.com/apps → Your App → OAuth & Permissions
# Required scopes: chat:write, channels:history, groups:history
# SLACK_BOT_TOKEN=YOUR_SLACK_BOT_TOKEN_HERE

# Slack Signing Secret (used to verify webhook requests)
# Get from: https://api.slack.com/apps → Your App → Basic Information
# SLACK_SIGNING_SECRET=YOUR_SLACK_SIGNING_SECRET_HERE

# ==============================================================================
# DEPLOYMENT SECURITY CHECKLIST
# ==============================================================================
#
# Before deploying to production, ensure:
#
# 1. ✅ WORKSPACE_BASE is set to a dedicated directory
# 2. ✅ Workspace directory has permissions 0700 or 0750
# 3. ✅ Workspace directory owner is the application user
# 4. ✅ LOG_DIR exists and has permissions 0750
# 5. ✅ PostgreSQL credentials are secure (not default passwords)
# 6. ✅ API_PORT is not exposed to public internet (use reverse proxy)
# 7. ✅ All secrets are in .env (not .env.example)
# 8. ✅ .env is in .gitignore (never commit secrets)
# 9. ✅ Rate limiting is enabled and configured
# 10. ✅ Resource limits are set appropriately for your environment
# 11. ✅ BLOB_LOCAL_PATH directory exists with permissions 0750 (if using local blob storage)
# 12. ✅ S3 bucket has appropriate IAM permissions (if using S3 blob storage)
# 13. ✅ AWS credentials are securely managed (prefer IAM roles over static keys)
#
# SECURITY MONITORING:
# - Set up log monitoring for security events
# - Configure alerts for rate limit violations
# - Monitor workspace disk usage
# - Monitor blob storage usage and cleanup old blobs
# - Review security logs daily
# - Implement log rotation for LOG_DIR
#
# ==============================================================================
